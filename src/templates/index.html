<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>{{ app_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <h1>{{ app_title }}</h1>
    <p>ローカルで whisper.cpp を使って MP3 を文字起こしします。対象ファイルをアップロードし、必要なら設定を調整してください。</p>
    <div class="messages">
      {% for category, message in get_flashed_messages(with_categories=true) %}
        <p class="{{ category }}">{{ message }}</p>
      {% endfor %}
    </div>
    <form method="post" enctype="multipart/form-data" id="upload-form">
      <div class="drop-zone" id="drop-zone">
        <div class="drop-zone-text">MP3 ファイルをドラッグ&ドロップ または クリックして選択</div>
        <div class="drop-zone-file" id="file-name"></div>
      </div>
      <input type="file" id="mp3" name="mp3" accept="audio/mpeg" required>

      <div class="form-grid">
        <div>
          <label for="language">言語コード</label>
          <select id="language" name="language">
            <option value="ja" selected>日本語 (ja)</option>
            <option value="en">英語 (en)</option>
            <option value="auto">自動検出 (auto)</option>
          </select>
        </div>

        <div>
          <label for="beam_size">ビームサーチ幅</label>
          <input type="number" id="beam_size" name="beam_size" value="5" min="1" max="20">
        </div>

        <div>
          <label for="best_of">保持候補数 (best-of)</label>
          <input type="number" id="best_of" name="best_of" value="5" min="1" max="20">
        </div>

        <div>
          <label for="temperature">サンプリング温度</label>
          <input type="number" id="temperature" name="temperature" value="0.0" min="0" max="1" step="0.1">
        </div>

        <div>
          <label for="threads">スレッド数 (0 で自動判定)</label>
          <input type="number" id="threads" name="threads" value="0" min="0" max="32">
        </div>
      </div>

      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" name="enable_vad">
          音声区間検出 (VAD) を有効化
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="allow_nst">
          非音声トークンの抑制を解除 (--allow-nst)
        </label>
      </div>

      <button type="submit">文字起こしを実行</button>
    </form>
    <div id="loading-overlay" class="loading hidden">
      <div class="spinner"></div>
      <p>文字起こしを実行中です…<br>完了までブラウザを閉じずにお待ちください。</p>
    </div>
    <footer>
      whisper-cli: {{ default_binary }}<br>
      モデル: {{ default_model }}
    </footer>

    <script>
      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('mp3');
      const fileNameDisplay = document.getElementById('file-name');
      const form = document.getElementById('upload-form');
      const overlay = document.getElementById('loading-overlay');

      // クリックでファイル選択
      dropZone.addEventListener('click', () => fileInput.click());

      // ファイル選択時の処理
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          const fileName = e.target.files[0].name;
          fileNameDisplay.textContent = fileName;
          dropZone.classList.add('has-file');
        }
      });

      // ドラッグオーバー時
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      // ドラッグ離脱時
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      // ドロップ時
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (file.type === 'audio/mpeg' || file.name.endsWith('.mp3')) {
            fileInput.files = files;
            fileNameDisplay.textContent = file.name;
            dropZone.classList.add('has-file');
          } else {
            alert('MP3ファイルのみアップロード可能です');
          }
        }
      });

      form?.addEventListener('submit', () => {
        overlay?.classList.remove('hidden');
        overlay?.classList.add('visible');
      });
    </script>
  </body>
</html>
